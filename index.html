import React, { useState, useEffect, useCallback, useRef } from 'react';

// Componente principal da aplicaÃ§Ã£o
export default function App() {
  // Estilos globais injetados no cabeÃ§alho do documento
  const GlobalStyles = () => (
    <style>{`
      :root {
        --primary-purple: #7F5AF0;
        --primary-purple-light: #9D86F5;
        --accent-green: #2CB67D;
        --accent-yellow: #FFD700;
        --card-bg: rgba(26, 23, 38, 0.6);
        --card-bg-solid: #1A1726;
        --text-primary: #FFFFFE;
        --text-secondary: #94A1B2;
        --text-tertiary: #72757E;
        --border-color: rgba(127, 90, 240, 0.2);
        --border-radius: 16px;
        --shadow: 0 8px 32px rgba(13, 12, 34, 0.3);
        --backdrop-blur: 10px;
      }

      * { margin: 0; padding: 0; box-sizing: border-box; }

      html { scroll-behavior: smooth; }

      body {
        font-family: 'Inter', sans-serif;
        background-color: #16161A;
        background-image: 
            radial-gradient(circle at 1px 1px, rgba(127, 90, 240, 0.2) 1px, transparent 0),
            radial-gradient(circle at top left, #2E2359, #16161A 40%);
        background-size: 32px 32px, 100% 100%;
        min-height: 100vh;
        color: var(--text-primary);
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      ::-webkit-scrollbar { width: 8px; }
      ::-webkit-scrollbar-track { background: #1A1726; }
      ::-webkit-scrollbar-thumb { background: var(--primary-purple); border-radius: 4px; }
      ::-webkit-scrollbar-thumb:hover { background: var(--primary-purple-light); }

      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
      @keyframes slideUp { from { transform: translateY(50px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
      @keyframes slideIn { from { transform: translateX(120%); } to { transform: translateX(0); } }
      @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(120%); } }
      
      .btn-loading::after {
        content: '';
        position: absolute;
        width: 16px;
        height: 16px;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        margin: auto;
        border: 2px solid transparent;
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spin .5s linear infinite;
      }

      .status-badge {
        display: inline-block; padding: 4px 12px;
        border-radius: 20px; font-size: 0.75rem;
        font-weight: 600; cursor: pointer;
        transition: all 0.3s ease;
        user-select: none;
      }
      .status-confirmed, .status-complete, .status-closed { background: rgba(44, 182, 125, 0.2); color: var(--accent-green); }
      .status-tentative { background: rgba(255, 215, 0, 0.2); color: var(--accent-yellow); }
      .status-open, .status-Open { background: rgba(127, 90, 240, 0.2); color: #C4B5FD; }
      .status-progress, .status-in.progress { background: rgba(250, 140, 22, 0.2); color: #FA8C16; }
      .status-review { background: rgba(24, 144, 255, 0.2); color: #1890FF; }
      .status-cancelled { background: rgba(239, 68, 68, 0.2); color: #F87171; }
    `}</style>
  );

  // Estado para gerir os dados e a interface do utilizador
  const [events, setEvents] = useState([]);
  const [tasks, setTasks] = useState([]);
  const [currentView, setCurrentView] = useState('dashboard');
  const [currentPeriod, setCurrentPeriod] = useState('dia');
  const [customPeriod, setCustomPeriod] = useState({ active: false, start: null, end: null });
  const [filters, setFilters] = useState({ text: '', setor: '', date: '' });
  const [loading, setLoading] = useState(true);
  const [notifications, setNotifications] = useState([]);
  const [isQuickModalOpen, setQuickModalOpen] = useState(false);
  const [isNavMenuOpen, setNavMenuOpen] = useState(false);
  const [isCustomPeriodOpen, setCustomPeriodOpen] = useState(false);
  const [isAdvancedFiltersOpen, setAdvancedFiltersOpen] = useState(false);
  const [decomposingTask, setDecomposingTask] = useState(null);

  // ConfiguraÃ§Ãµes da API
  const CONFIG = {
    N8N_BASE_URL: 'https://n8n-x8go8cgk0g0c0wc4004wosoc.themodernservers.com',
    ENDPOINTS: {
        EVENTS: '/webhook/dashboard-events',
        TASKS: '/webhook/clickup-tasks',
        CREATE_TASK: '/webhook/dashboard-create-task',
        CREATE_EVENT: '/webhook/dashboard-create-event',
        CREATE_BULK_TASKS: '/webhook/dashboard-bulk-tasks',
        UPDATE_TASK_STATUS: '/webhook/dashboard-update-task-status'
    },
    AUTO_SYNC: 300000
  };

  // FunÃ§Ã£o para mostrar notificaÃ§Ãµes
  const showNotification = useCallback((message, type = 'info') => {
    const id = Date.now();
    setNotifications(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setNotifications(prev => prev.filter(n => n.id !== id));
    }, 3500);
  }, []);

  // FunÃ§Ãµes para carregar dados da API
  const loadCalendarEvents = useCallback(async () => {
    try {
      const response = await fetch(`${CONFIG.N8N_BASE_URL}${CONFIG.ENDPOINTS.EVENTS}`);
      const data = await response.json();
      setEvents(data.success ? data.events || [] : []);
    } catch (error) {
      console.error('Erro ao carregar eventos:', error);
      showNotification('Falha ao carregar eventos.', 'error');
    }
  }, [CONFIG.N8N_BASE_URL, CONFIG.ENDPOINTS.EVENTS, showNotification]);

  const loadClickUpTasks = useCallback(async () => {
    try {
      const response = await fetch(`${CONFIG.N8N_BASE_URL}${CONFIG.ENDPOINTS.TASKS}`);
      const data = await response.json();
      if (data.success && Array.isArray(data.tasks)) {
        const processedTasks = data.tasks.map(task => ({ 
            id: task.id || `task-${Date.now()}`, 
            title: task.title || task.name || 'Demanda sem nome', 
            description: task.description || '', 
            setor: task.setor || task.sector || 'Geral', 
            status: task.status?.toLowerCase() || 'open', 
            assignees: task.assignees || [], 
            due_date: task.due_date, 
            start: task.start || new Date().toISOString(), 
            url: task.url, 
            priority: task.priority || 'normal' 
        }));
        setTasks(processedTasks);
      } else {
        setTasks([]);
      }
    } catch (error) {
      console.error('âŒ Erro ao carregar ClickUp:', error);
      showNotification('Falha ao carregar demandas.', 'error');
    }
  }, [CONFIG.N8N_BASE_URL, CONFIG.ENDPOINTS.TASKS, showNotification]);

  const loadAllData = useCallback(async () => {
    setLoading(true);
    await Promise.all([loadCalendarEvents(), loadClickUpTasks()]);
    setLoading(false);
    showNotification('Dados sincronizados! ğŸ¦‹', 'success');
  }, [loadCalendarEvents, loadClickUpTasks, showNotification]);

  // Efeito para carregar dados iniciais e configurar auto-sync
  useEffect(() => {
    loadAllData();
    const syncInterval = setInterval(loadAllData, CONFIG.AUTO_SYNC);
    return () => clearInterval(syncInterval);
  }, [loadAllData, CONFIG.AUTO_SYNC]);

  // FunÃ§Ãµes de filtragem e ordenaÃ§Ã£o
  const getFilteredData = useCallback(() => {
    let now = new Date();
    let startDate, endDate;

    if (customPeriod.active) {
        startDate = customPeriod.start;
        endDate = customPeriod.end;
    } else {
        switch(currentPeriod) {
            case 'dia':
                startDate = new Date(new Date().setHours(0,0,0,0));
                endDate = new Date(new Date().setHours(23,59,59,999));
                break;
            case 'semana':
                const first = now.getDate() - now.getDay();
                startDate = new Date(new Date(now.setDate(first)).setHours(0,0,0,0));
                endDate = new Date(new Date(now.setDate(first + 6)).setHours(23,59,59,999));
                break;
            case 'mes':
                startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                endDate = new Date(new Date(now.getFullYear(), now.getMonth() + 1, 0).setHours(23,59,59,999));
                break;
            default:
                startDate = null;
                endDate = null;
        }
    }

    const periodFilteredEvents = startDate && endDate 
        ? events.filter(e => new Date(e.start) >= startDate && new Date(e.start) <= endDate)
        : events;

    const periodFilteredTasks = startDate && endDate
        ? tasks.filter(t => new Date(t.start) >= startDate && new Date(t.start) <= endDate)
        : tasks;

    const applyAdvancedFilters = (items, type) => {
        return items.filter(item => {
            const textMatch = !filters.text || 
                              item.title.toLowerCase().includes(filters.text.toLowerCase()) || 
                              (item.description && item.description.toLowerCase().includes(filters.text.toLowerCase()));
            const setorMatch = type === 'event' || !filters.setor || item.setor === filters.setor;
            const dateMatch = !filters.date || new Date(item.start || item.due_date).toDateString() === new Date(filters.date).toDateString();
            return textMatch && setorMatch && dateMatch;
        });
    };

    return {
        filteredEvents: applyAdvancedFilters(periodFilteredEvents, 'event'),
        filteredTasks: applyAdvancedFilters(periodFilteredTasks, 'task'),
    };
  }, [events, tasks, currentPeriod, customPeriod, filters]);

  const { filteredEvents, filteredTasks } = getFilteredData();

  // FunÃ§Ãµes de manipulaÃ§Ã£o de estado da interface
  const handleSetPeriod = (period) => {
    setCurrentPeriod(period);
    setCustomPeriod({ active: false, start: null, end: null });
    setCustomPeriodOpen(false);
  };
  
  const handleApplyCustomPeriod = (start, end) => {
    if (!start || !end || new Date(start) > new Date(end)) {
        showNotification('âš ï¸ PerÃ­odo invÃ¡lido', 'error');
        return;
    }
    setCurrentPeriod('custom');
    setCustomPeriod({ active: true, start: new Date(start), end: new Date(new Date(end).setHours(23,59,59,999)) });
    setCustomPeriodOpen(false);
    showNotification(`ğŸ“† PerÃ­odo personalizado aplicado.`, 'info');
  };

  const handleSelectView = (viewName) => {
    setCurrentView(viewName);
    setNavMenuOpen(false);
  };
  
  // RenderizaÃ§Ã£o dos componentes
  return (
    <>
      <GlobalStyles />
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
      
      <div className="container" style={{maxWidth: '1400px', margin: '0 auto', padding: '32px 24px'}}>
        <Header />
        <Navigation 
            currentView={currentView} 
            onSelectView={handleSelectView}
            isNavMenuOpen={isNavMenuOpen}
            setNavMenuOpen={setNavMenuOpen}
        />
        <PeriodFilters 
            currentPeriod={currentPeriod}
            onSetPeriod={handleSetPeriod}
            onApplyCustomPeriod={handleApplyCustomPeriod}
            isCustomPeriodOpen={isCustomPeriodOpen}
            setCustomPeriodOpen={setCustomPeriodOpen}
            onToggleAdvancedFilters={() => setAdvancedFiltersOpen(p => !p)}
        />
        {isAdvancedFiltersOpen && (
            <AdvancedFilters 
                filters={filters}
                setFilters={setFilters}
                allTasks={tasks}
            />
        )}
        <Metrics 
            totalItems={events.length + tasks.length}
            filteredItems={filteredEvents.length + filteredTasks.length}
            currentPeriod={currentPeriod}
            customPeriod={customPeriod}
        />
        <MainContent 
            currentView={currentView}
            events={filteredEvents}
            tasks={filteredTasks}
            onSyncCalendar={loadCalendarEvents}
            onSyncClickUp={loadClickUpTasks}
            showNotification={showNotification}
            setDecomposingTask={setDecomposingTask}
            refreshData={loadAllData}
            config={CONFIG}
        />
      </div>

      <FloatingActionButton onToggle={() => setQuickModalOpen(p => !p)} isOpen={isQuickModalOpen} />
      
      {isQuickModalOpen && (
        <QuickActionsModal 
            onClose={() => setQuickModalOpen(false)}
            showNotification={showNotification}
            config={CONFIG}
            refreshData={loadAllData}
        />
      )}

      {decomposingTask && (
        <DecompositionModal
            task={decomposingTask}
            onClose={() => setDecomposingTask(null)}
            showNotification={showNotification}
            config={CONFIG}
            refreshData={loadAllData}
        />
      )}

      <LoadingIndicator show={loading} />
      <NotificationCenter notifications={notifications} />
    </>
  );
}

// Subcomponentes

const Header = () => (
    <header className="header" style={{textAlign: 'center', marginBottom: '48px', color: 'white'}}>
        <h1 style={{fontSize: '3rem', marginBottom: '12px', fontWeight: 800, letterSpacing: '-1.5px'}}>ğŸµ Dashboard MERACHI</h1>
        <p style={{fontSize: '1.2rem', opacity: 0.8, marginBottom: '24px'}}>GestÃ£o de Demandas - Confia no Processo</p>
        <div className="badges" style={{display: 'flex', justifyContent: 'center', gap: '16px', flexWrap: 'wrap'}}>
            <div className="badge connected" style={{display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px', borderRadius: '12px', fontSize: '0.9rem', background: 'rgba(44, 182, 125, 0.15)', borderColor: 'rgba(44, 182, 125, 0.3)', color: '#BFF9DF', border: '1px solid'}}>ğŸ“… Google Calendar</div>
            <div className="badge connected" style={{display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px', borderRadius: '12px', fontSize: '0.9rem', background: 'rgba(44, 182, 125, 0.15)', borderColor: 'rgba(44, 182, 125, 0.3)', color: '#BFF9DF', border: '1px solid'}}>âœ… ClickUp</div>
            <div className="badge connected" style={{display: 'flex', alignItems: 'center', gap: '8px', padding: '10px 16px', borderRadius: '12px', fontSize: '0.9rem', background: 'rgba(44, 182, 125, 0.15)', borderColor: 'rgba(44, 182, 125, 0.3)', color: '#BFF9DF', border: '1px solid'}}>ğŸ”„ n8n</div>
        </div>
    </header>
);

const Navigation = ({ currentView, onSelectView, isNavMenuOpen, setNavMenuOpen }) => {
    const navRef = useRef(null);
    const viewLabels = {
        dashboard: 'ğŸ“Š Dashboard',
        agenda: 'ğŸ“… Eventos da Agenda',
        demandas: 'âœ… Demandas',
        calendario: 'ğŸ—“ï¸ CalendÃ¡rio',
    };

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (navRef.current && !navRef.current.contains(event.target)) {
                setNavMenuOpen(false);
            }
        };
        document.addEventListener("mousedown", handleClickOutside);
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [setNavMenuOpen]);

    return (
        <div ref={navRef} className="nav-menu" style={{marginBottom: '24px', position: 'relative', display: 'inline-block', minWidth: '280px', zIndex: 999}}>
            <div className="nav-dropdown" style={{position: 'relative', width: '100%'}}>
                <button className={`nav-current ${isNavMenuOpen ? 'open' : ''}`} onClick={() => setNavMenuOpen(!isNavMenuOpen)} style={{padding: '14px 24px', background: 'var(--card-bg)', border: '1px solid var(--border-color)', color: 'var(--text-primary)', borderRadius: 'var(--border-radius)', cursor: 'pointer', fontWeight: 600, fontSize: '1.1rem', width: '100%', display: 'flex', alignItems: 'center', justifyContent: 'space-between', backdropFilter: 'blur(var(--backdrop-blur))', transition: 'all 0.2s ease'}}>
                    {viewLabels[currentView]}
                    <span style={{fontSize: '0.8rem', transform: isNavMenuOpen ? 'rotate(180deg)' : 'rotate(0deg)', transition: 'transform 0.2s ease'}}>â–¼</span>
                </button>
                {isNavMenuOpen && (
                    <div className="nav-options open" style={{position: 'absolute', top: 'calc(100% + 8px)', left: 0, right: 0, background: 'var(--card-bg-solid)', border: '1px solid var(--border-color)', borderRadius: 'var(--border-radius)', boxShadow: 'var(--shadow)', zIndex: 9999, overflow: 'hidden', animation: 'fadeIn 0.2s ease'}}>
                        {Object.entries(viewLabels).map(([key, label]) => (
                            <button key={key} className="nav-option" onClick={() => onSelectView(key)} style={{padding: '14px 24px', border: 'none', background: 'transparent', color: 'var(--text-secondary)', cursor: 'pointer', fontWeight: 500, width: '100%', textAlign: 'left', transition: 'all 0.2s ease'}}>
                                {label}
                            </button>
                        ))}
                    </div>
                )}
            </div>
        </div>
    );
};

const PeriodFilters = ({ currentPeriod, onSetPeriod, onApplyCustomPeriod, isCustomPeriodOpen, setCustomPeriodOpen, onToggleAdvancedFilters }) => {
    const customPeriodRef = useRef(null);
    const [dates, setDates] = useState({ start: '', end: '' });

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (customPeriodRef.current && !customPeriodRef.current.contains(event.target)) {
                setCustomPeriodOpen(false);
            }
        };
        if (isCustomPeriodOpen) {
            document.addEventListener("mousedown", handleClickOutside);
        }
        return () => document.removeEventListener("mousedown", handleClickOutside);
    }, [isCustomPeriodOpen, setCustomPeriodOpen]);
    
    const handleApply = () => {
        onApplyCustomPeriod(dates.start, dates.end);
    };

    return (
        <div className="period-filters" style={{display: 'flex', justifyContent: 'center', alignItems: 'center', gap: '12px', marginBottom: '24px', padding: '12px', background: 'var(--card-bg)', border: '1px solid var(--border-color)', borderRadius: 'var(--border-radius)', backdropFilter: 'blur(var(--backdrop-blur))', boxShadow: 'var(--shadow)', flexWrap: 'wrap', zIndex: 500, position: 'relative'}}>
            <button className={`period-btn ${currentPeriod === 'dia' ? 'active' : ''}`} onClick={() => onSetPeriod('dia')} style={{padding: '10px 20px', border: '1px solid transparent', background: currentPeriod === 'dia' ? 'var(--primary-purple)' : 'transparent', color: currentPeriod === 'dia' ? 'white' : 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s ease'}}>ğŸ“… Dia</button>
            <button className={`period-btn ${currentPeriod === 'semana' ? 'active' : ''}`} onClick={() => onSetPeriod('semana')} style={{padding: '10px 20px', border: '1px solid transparent', background: currentPeriod === 'semana' ? 'var(--primary-purple)' : 'transparent', color: currentPeriod === 'semana' ? 'white' : 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s ease'}}>ğŸ“Š Semana</button>
            <button className={`period-btn ${currentPeriod === 'mes' ? 'active' : ''}`} onClick={() => onSetPeriod('mes')} style={{padding: '10px 20px', border: '1px solid transparent', background: currentPeriod === 'mes' ? 'var(--primary-purple)' : 'transparent', color: currentPeriod === 'mes' ? 'white' : 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s ease'}}>ğŸ“‹ MÃªs</button>
            <div ref={customPeriodRef} className="custom-period-dropdown" style={{position: 'relative', display: 'inline-block'}}>
                <button className={`period-btn ${currentPeriod === 'custom' ? 'active' : ''}`} onClick={() => setCustomPeriodOpen(!isCustomPeriodOpen)} style={{padding: '10px 20px', border: '1px solid transparent', background: currentPeriod === 'custom' ? 'var(--primary-purple)' : 'transparent', color: currentPeriod === 'custom' ? 'white' : 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s ease'}}>ğŸ“† PerÃ­odo</button>
                {isCustomPeriodOpen && (
                    <div className="custom-period-content open" style={{position: 'absolute', top: 'calc(100% + 8px)', left: '50%', transform: 'translateX(-50%)', background: 'var(--card-bg-solid)', border: '1px solid var(--border-color)', borderRadius: 'var(--border-radius)', boxShadow: 'var(--shadow)', padding: '20px', marginTop: '8px', zIndex: 100, minWidth: '300px', animation: 'fadeIn 0.2s ease'}}>
                        <div className="date-input-group" style={{marginBottom: '16px'}}>
                            <label className="date-input-label" style={{display: 'block', fontWeight: 600, color: 'var(--text-primary)', marginBottom: '8px', fontSize: '0.9rem'}}>Data Inicial:</label>
                            <input type="date" className="date-input" value={dates.start} onChange={e => setDates({...dates, start: e.target.value})} style={{width: '100%', padding: '10px 14px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)', borderRadius: '8px', fontSize: '0.9rem', transition: 'all 0.2s ease'}} />
                        </div>
                        <div className="date-input-group" style={{marginBottom: '16px'}}>
                            <label className="date-input-label" style={{display: 'block', fontWeight: 600, color: 'var(--text-primary)', marginBottom: '8px', fontSize: '0.9rem'}}>Data Final:</label>
                            <input type="date" className="date-input" value={dates.end} onChange={e => setDates({...dates, end: e.target.value})} style={{width: '100%', padding: '10px 14px', border: '1px solid var(--border-color)', background: 'var(--card-bg)', color: 'var(--text-primary)', borderRadius: '8px', fontSize: '0.9rem', transition: 'all 0.2s ease'}} />
                        </div>
                        <button className="apply-period-btn" onClick={handleApply} style={{width: '100%', padding: '12px', background: 'var(--primary-purple)', color: 'white', border: 'none', borderRadius: '8px', fontWeight: 600, cursor: 'pointer', transition: 'all 0.2s ease', marginTop: '8px'}}>Aplicar PerÃ­odo</button>
                    </div>
                )}
            </div>
            <button className="period-btn" onClick={onToggleAdvancedFilters} style={{padding: '10px 20px', border: '1px solid transparent', background: 'transparent', color: 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontWeight: 600, fontSize: '0.9rem', transition: 'all 0.2s ease'}}>ğŸ” Filtros</button>
        </div>
    );
};

const AdvancedFilters = ({ filters, setFilters, allTasks }) => {
    const setores = [...new Set(allTasks.map(task => task.setor || 'Geral'))].sort();
    
    const handleFilterChange = (e) => {
        const { id, value } = e.target;
        setFilters(prev => ({ ...prev, [id]: value }));
    };

    const clearAllFilters = () => {
        setFilters({ text: '', setor: '', date: '' });
    };

    return (
        <div className="advanced-filters" style={{background: 'var(--card-bg)', border: '1px solid var(--border-color)', backdropFilter: 'blur(var(--backdrop-blur))', borderRadius: 'var(--border-radius)', padding: '24px', marginBottom: '24px', boxShadow: 'var(--shadow)', animation: 'fadeIn 0.3s ease'}}>
            <div className="filters-title" style={{fontWeight: 600, fontSize: '1.1rem', color: 'var(--text-primary)', marginBottom: '20px', display: 'flex', alignItems: 'center', gap: '10px'}}>
                ğŸ” Filtros AvanÃ§ados
                <button className="clear-filters" onClick={clearAllFilters} style={{marginLeft: 'auto', padding: '8px 16px', background: 'rgba(255, 255, 255, 0.1)', border: 'none', borderRadius: '8px', color: 'var(--text-secondary)', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 500}}>Limpar Filtros</button>
            </div>
            <div className="filters-row" style={{display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '16px', marginBottom: '16px'}}>
                <input type="text" className="filter-input" id="text" placeholder="Buscar por tÃ­tulo..." value={filters.text} onChange={handleFilterChange} style={{padding: '12px 16px', border: '1px solid var(--border-color)', borderRadius: '12px', fontSize: '0.9rem', background: '#16161A', color: 'var(--text-primary)'}} />
                <select className="filter-input" id="setor" value={filters.setor} onChange={handleFilterChange} style={{padding: '12px 16px', border: '1px solid var(--border-color)', borderRadius: '12px', fontSize: '0.9rem', background: '#16161A', color: 'var(--text-primary)'}}>
                    <option value="">Todos os setores</option>
                    {setores.map(setor => <option key={setor} value={setor}>{setor}</option>)}
                </select>
                <input type="date" className="filter-input" id="date" value={filters.date} onChange={handleFilterChange} style={{padding: '12px 16px', border: '1px solid var(--border-color)', borderRadius: '12px', fontSize: '0.9rem', background: '#16161A', color: 'var(--text-primary)'}} />
            </div>
        </div>
    );
};

const Metrics = ({ totalItems, filteredItems, currentPeriod, customPeriod }) => {
    const getPeriodLabel = () => {
        if (currentPeriod === 'custom' && customPeriod.active) {
            const start = new Date(customPeriod.start).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            const end = new Date(customPeriod.end).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
            return `${start} - ${end}`;
        }
        const labels = { 'dia': 'Hoje', 'semana': 'Esta Semana', 'mes': 'Este MÃªs' };
        return labels[currentPeriod];
    };

    return (
        <div className="metrics" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px', marginBottom: '32px'}}>
            <div className="metric-card" style={{background: 'var(--card-bg)', border: '1px solid var(--border-color)', padding: '32px', borderRadius: 'var(--border-radius)', boxShadow: 'var(--shadow)', textAlign: 'center', backdropFilter: 'blur(var(--backdrop-blur))', transition: 'transform 0.2s ease, box-shadow 0.2s ease'}}>
                <div className="metric-number" style={{fontSize: '3.5rem', fontWeight: 800, color: 'var(--primary-purple)', marginBottom: '8px', letterSpacing: '-2px'}}>{totalItems}</div>
                <div className="metric-label" style={{fontSize: '1rem', fontWeight: 500, color: 'var(--text-secondary)'}}>Total de Itens</div>
            </div>
            <div className="metric-card" style={{background: 'var(--card-bg)', border: '1px solid var(--border-color)', padding: '32px', borderRadius: 'var(--border-radius)', boxShadow: 'var(--shadow)', textAlign: 'center', backdropFilter: 'blur(var(--backdrop-blur))', transition: 'transform 0.2s ease, box-shadow 0.2s ease'}}>
                <div className="metric-number" style={{fontSize: '3.5rem', fontWeight: 800, color: 'var(--primary-purple)', marginBottom: '8px', letterSpacing: '-2px'}}>{filteredItems}</div>
                <div className="metric-label" style={{fontSize: '1rem', fontWeight: 500, color: 'var(--text-secondary)'}}>{getPeriodLabel()}</div>
            </div>
        </div>
    );
};

const MainContent = ({ currentView, events, tasks, onSyncCalendar, onSyncClickUp, showNotification, setDecomposingTask, refreshData, config }) => {
    const renderView = () => {
        switch (currentView) {
            case 'dashboard':
                return (
                    <div className="split-view" style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '24px'}}>
                        <Section title="ğŸ“… Eventos da Agenda" onSync={onSyncCalendar}>
                            <ItemsList items={events} type="event" showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />
                        </Section>
                        <Section title="âœ… Demandas" onSync={onSyncClickUp}>
                            <TasksBySector tasks={tasks} showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />
                        </Section>
                    </div>
                );
            case 'agenda':
                return (
                    <Section title="ğŸ“… Eventos da Agenda" onSync={onSyncCalendar}>
                        <ItemsList items={events} type="event" showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />
                    </Section>
                );
            case 'demandas':
                return (
                    <Section title="âœ… Demandas por Setor" onSync={onSyncClickUp}>
                        <TasksBySector tasks={tasks} showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />
                    </Section>
                );
            case 'calendario':
                return (
                    <Section title="ğŸ—“ï¸ VisÃ£o de CalendÃ¡rio">
                        <CalendarView events={events} tasks={tasks} />
                    </Section>
                );
            default:
                return null;
        }
    };

    return (
        <main className="main-content" style={{display: 'grid', gridTemplateColumns: '1fr', gap: '32px'}}>
            <div className="content-view active" style={{display: 'block'}}>
                {renderView()}
            </div>
        </main>
    );
};

const Section = ({ title, onSync, children }) => (
    <section className="section" style={{background: 'var(--card-bg)', border: '1px solid var(--border-color)', borderRadius: 'var(--border-radius)', padding: '24px 32px', boxShadow: 'var(--shadow)', marginBottom: '24px', backdropFilter: 'blur(var(--backdrop-blur))'}}>
        <div className="section-title" style={{fontSize: '1.5rem', fontWeight: 700, marginBottom: '24px', color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '12px'}}>
            {title}
            {onSync && <button className="sync-btn" onClick={onSync} style={{marginLeft: 'auto', padding: '10px 20px', border: '1px solid var(--border-color)', background: 'rgba(255, 255, 255, 0.05)', color: 'var(--text-secondary)', borderRadius: '12px', cursor: 'pointer', fontSize: '0.9rem', fontWeight: 600, transition: 'all 0.2s ease'}}>ğŸ”„ Sync</button>}
        </div>
        {children}
    </section>
);

const ItemsList = ({ items, type, showNotification, setDecomposingTask, refreshData, config }) => {
    if (items.length === 0) {
        return <div className="empty-state" style={{textAlign: 'center', padding: '60px', color: 'var(--text-secondary)', fontSize: '1.1rem'}}>ğŸ“­ Nenhum item encontrado</div>;
    }
    return items.map(item => <Item key={item.id} item={item} type={type} showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />);
};

const TasksBySector = ({ tasks, showNotification, setDecomposingTask, refreshData, config }) => {
    if (tasks.length === 0) {
        return <div className="empty-state" style={{textAlign: 'center', padding: '60px', color: 'var(--text-secondary)', fontSize: '1.1rem'}}>ğŸ“­ Nenhuma demanda encontrada</div>;
    }
    const tasksPorSetor = tasks.reduce((acc, task) => {
        const setor = task.setor || 'Geral';
        if (!acc[setor]) acc[setor] = [];
        acc[setor].push(task);
        return acc;
    }, {});
    const ordem = ['Design', 'Audiovisual', 'Social Media', 'GestÃ£o de Projetos', 'EstÃºdio', 'MÃºsico', 'Geral'];
    const setoresOrdenados = Object.keys(tasksPorSetor).sort((a,b) => (ordem.indexOf(a) === -1 ? 99 : ordem.indexOf(a)) - (ordem.indexOf(b) === -1 ? 99 : ordem.indexOf(b)));
    
    return setoresOrdenados.map(setor => (
        <div key={setor} className="sector-section" style={{marginBottom: '32px'}}>
            <div className="sector-title" style={{fontSize: '1.1rem', fontWeight: 600, color: 'var(--primary-purple-light)', marginBottom: '16px', padding: '10px 16px', background: 'rgba(127, 90, 240, 0.1)', borderRadius: '12px', display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                {`${getSectorIcon(setor)} ${setor}`}
                <span className="sector-count" style={{background: 'var(--primary-purple)', color: 'white', padding: '4px 10px', borderRadius: '20px', fontSize: '0.8rem', fontWeight: 700}}>{tasksPorSetor[setor].length}</span>
            </div>
            {tasksPorSetor[setor].map(task => <Item key={task.id} item={task} type="task" showNotification={showNotification} setDecomposingTask={setDecomposingTask} refreshData={refreshData} config={config} />)}
        </div>
    ));
};

const getSectorIcon = (setor) => ({ 'Design': 'ğŸ¨', 'Audiovisual': 'ğŸ¬', 'Social Media': 'ğŸ“±', 'GestÃ£o de Projetos': 'ğŸ“Š', 'EstÃºdio': 'ğŸµ', 'EstÃºdio ': 'ğŸµ', 'MÃºsico': 'ğŸ¤', 'Geral': 'ğŸ“‹' }[setor.trim()] || 'ğŸ“‹');

const Item = ({ item, type, showNotification, setDecomposingTask, refreshData, config }) => {
    const clickTimeout = useRef(null);

    const getStatusLabel = (status) => {
        if (type === 'event') {
            return { 'confirmed': 'âœ… Confirmado', 'tentative': 'â³ Tentativo', 'cancelled': 'âŒ Cancelado' }[status] || status;
        }
        return { 'open': 'ğŸ“‹ Aberta', 'progress': 'âš¡ Progresso', 'review': 'ğŸ‘€ RevisÃ£o', 'complete': 'âœ… Completa', 'closed': 'âœ… Fechada' }[status] || `ğŸ“ ${status}`;
    };

    const handleStatusUpdate = async (newStatus) => {
        try {
            const response = await fetch(`${config.N8N_BASE_URL}${config.ENDPOINTS.UPDATE_TASK_STATUS}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ task_id: item.id, new_status: newStatus })
            });
            const result = await response.json();
            if (result.success) {
                showNotification(`Estado atualizado para ${getStatusLabel(newStatus)}`, 'success');
                refreshData();
            } else {
                throw new Error(result.message || 'Falha ao atualizar estado');
            }
        } catch (error) {
            showNotification(error.message, 'error');
        }
    };

    const handleStatusClick = () => {
        if (type !== 'task') return;

        if (clickTimeout.current) {
            // Double click
            clearTimeout(clickTimeout.current);
            clickTimeout.current = null;
            handleStatusUpdate('open'); // Reset to open
        } else {
            // Single click
            clickTimeout.current = setTimeout(() => {
                const statuses = ['open', 'progress', 'review', 'complete'];
                const currentIndex = statuses.indexOf(item.status);
                const nextStatus = statuses[(currentIndex + 1) % statuses.length];
                handleStatusUpdate(nextStatus);
                clickTimeout.current = null;
            }, 250);
        }
    };

    const dueDate = item.due_date ? new Date(item.due_date) : null;
    let dueDateHTML = '';
    if (dueDate) {
        const now = new Date(); now.setHours(0,0,0,0);
        const isOverdue = dueDate < now;
        const dueDateText = dueDate.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: '2-digit' });
        dueDateHTML = `<span style="color:${isOverdue ? '#F87171' : 'inherit'}; font-weight: ${isOverdue ? '600' : '500'};">ğŸ“… ${dueDateText} ${isOverdue ? '(Vencida)' : ''}</span>`;
    }

    return (
        <div className="item" style={{padding: '20px', marginBottom: '12px', background: 'rgba(127, 90, 240, 0.05)', borderRadius: '12px', borderLeft: '5px solid var(--primary-purple)', cursor: 'pointer', transition: 'all 0.2s ease', position: 'relative'}}>
            <div className="item-title" style={{fontWeight: 600, fontSize: '1.1rem', marginBottom: '10px', color: 'var(--text-primary)', lineHeight: 1.4}}>{item.title}</div>
            <div className="item-meta" style={{fontSize: '0.85rem', color: 'var(--text-secondary)', display: 'flex', gap: '16px', flexWrap: 'wrap', alignItems: 'center'}}>
                {type === 'event' && <span>ğŸ• {new Date(item.start).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}</span>}
                {type === 'task' && item.assignees?.length > 0 && <span>ğŸ‘¤ {item.assignees.join(', ')}</span>}
                {type === 'task' && dueDateHTML && <span dangerouslySetInnerHTML={{ __html: dueDateHTML }} />}
                <span className={`status-badge status-${item.status.replace(' ','.')}`} onClick={handleStatusClick} title="Clique para avanÃ§ar, clique duplo para resetar">
                    {getStatusLabel(item.status)}
                </span>
                {type === 'task' && (
                    <button onClick={(e) => { e.stopPropagation(); setDecomposingTask(item); }} title="Decompor tarefa com IA" style={{background: 'none', border: 'none', color: 'var(--primary-purple-light)', cursor: 'pointer', fontSize: '1.2rem', padding: '0 5px'}}>
                        âœ¨
                    </button>
                )}
            </div>
            {item.description && <div style={{fontSize: '0.85rem', color: 'var(--text-secondary)', marginTop: '8px', lineHeight: 1.5}}>{item.description.substring(0,120)}{item.description.length > 120 ? '...' : ''}</div>}
        </div>
    );
};

const CalendarView = ({ events, tasks }) => {
    const now = new Date();
    const year = now.getFullYear();
    const month = now.getMonth();
    const monthLabel = now.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    
    const days = Array.from({ length: 42 }).map((_, i) => {
        const date = new Date(startDate);
        date.setDate(date.getDate() + i);
        return date;
    });

    const getItemsForDate = (date, items) => items.filter(item => new Date(item.start).toDateString() === date.toDateString());

    return (
        <div>
            <div style={{textAlign: 'center', fontSize: '1.2rem', fontWeight: 600, marginBottom: '20px'}}>{monthLabel}</div>
            <div className="calendar-view" style={{display: 'grid', gridTemplateColumns: 'repeat(7, 1fr)', gap: '8px', marginTop: '16px'}}>
                {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'SÃ¡b'].map(day => (
                    <div key={day} className="calendar-day-header" style={{textAlign: 'center', fontWeight: 600, padding: '12px', background: 'rgba(255, 255, 255, 0.05)', borderRadius: '12px', fontSize: '0.85rem', color: 'var(--text-secondary)'}}>{day}</div>
                ))}
                {days.map(date => (
                    <div key={date.toISOString()} className={`calendar-day ${date.toDateString() === now.toDateString() ? 'today' : ''} ${date.getMonth() !== month ? 'other-month' : ''}`} style={{aspectRatio: 1, border: `1px solid ${date.toDateString() === now.toDateString() ? 'var(--primary-purple)' : 'var(--border-color)'}`, borderRadius: '12px', padding: '8px', fontSize: '0.8rem', position: 'relative', minHeight: '100px', overflow: 'hidden', background: date.toDateString() === now.toDateString() ? 'rgba(127, 90, 240, 0.1)' : 'rgba(255, 255, 255, 0.02)', transition: 'all 0.2s ease', opacity: date.getMonth() !== month ? 0.3 : 1}}>
                        <div style={{fontWeight: 600, marginBottom: '4px'}}>{date.getDate()}</div>
                        {getItemsForDate(date, events).map(e => <div key={e.id} className="calendar-event" style={{background: 'var(--primary-purple)', color: 'white', padding: '3px 6px', borderRadius: '4px', fontSize: '0.7rem', margin: '3px 0', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', lineHeight: 1.3}} title={e.title}>{e.title}</div>)}
                        {getItemsForDate(date, tasks).map(t => <div key={t.id} className="calendar-task" style={{background: 'var(--accent-green)', color: 'var(--card-bg-solid)', padding: '3px 6px', borderRadius: '4px', fontSize: '0.7rem', margin: '3px 0', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', lineHeight: 1.3, fontWeight: 600}} title={t.title}>{t.title}</div>)}
                    </div>
                ))}
            </div>
        </div>
    );
};

const FloatingActionButton = ({ onToggle, isOpen }) => (
    <button className={`fab ${isOpen ? 'active' : ''}`} onClick={onToggle} style={{position: 'fixed', bottom: '30px', right: '30px', width: '64px', height: '64px', background: isOpen ? '#EF4444' : 'linear-gradient(135deg, var(--primary-purple), var(--primary-purple-light))', border: 'none', borderRadius: '50%', boxShadow: '0 10px 30px rgba(127, 90, 240, 0.4)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', color: 'white', transition: 'all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1)', zIndex: 1001, transform: isOpen ? 'rotate(45deg)' : 'none'}}>
        {isOpen ? 'âœ•' : 'â•'}
    </button>
);

const QuickActionsModal = ({ onClose, showNotification, config, refreshData }) => {
    const modalRef = useRef(null);
    const [activeTab, setActiveTab] = useState('task');
    const [taskData, setTaskData] = useState({ title: '', setor: '', priority: 'normal', due_date: '', assignee: '', description: '' });
    const [eventData, setEventData] = useState({ title: '', date: '', time: '', duration: '60', location: '', attendees: '', description: '' });
    const [bulkData, setBulkData] = useState({ text: '', default_setor: '', default_priority: '', default_assignee: '' });
    const [isSubmitting, setSubmitting] = useState(false);
    const [isGenerating, setIsGenerating] = useState(false);

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (modalRef.current && !modalRef.current.contains(event.target)) {
                onClose();
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [onClose]);

    const handleGenerateDescription = async () => {
        if (!taskData.title) {
            showNotification("Por favor, insira um tÃ­tulo para a tarefa primeiro.", "error");
            return;
        }
        setIsGenerating(true);
        try {
            const prompt = `Gere uma descriÃ§Ã£o curta e objetiva para uma tarefa com o tÃ­tulo "${taskData.title}". A descriÃ§Ã£o deve ser Ãºtil para quem for executar a tarefa. Se o tÃ­tulo mencionar um setor, considere isso na descriÃ§Ã£o.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = "";
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.candidates && result.candidates.length > 0) {
                const text = result.candidates[0].content.parts[0].text;
                setTaskData(prev => ({ ...prev, description: text }));
                showNotification("DescriÃ§Ã£o gerada com sucesso!", "success");
            } else {
                throw new Error("A API nÃ£o retornou uma descriÃ§Ã£o.");
            }
        } catch (error) {
            showNotification(`Erro ao gerar descriÃ§Ã£o: ${error.message}`, "error");
        } finally {
            setIsGenerating(false);
        }
    };

    const handleFormSubmit = async (e) => {
        e.preventDefault();
        setSubmitting(true);
        try {
            let endpoint, payload, successMessage;
            if (activeTab === 'task') {
                endpoint = config.ENDPOINTS.CREATE_TASK;
                payload = { ...taskData, source: 'dashboard_quick_action', created_at: new Date().toISOString() };
                successMessage = 'âœ… Tarefa criada com sucesso!';
            } else if (activeTab === 'event') {
                const { date, time, duration, ...rest } = eventData;
                const startDateTime = new Date(`${date}T${time}`);
                const endDateTime = new Date(startDateTime.getTime() + parseInt(duration) * 60000);
                endpoint = config.ENDPOINTS.CREATE_EVENT;
                payload = { ...rest, start_datetime: startDateTime.toISOString(), end_datetime: endDateTime.toISOString(), attendees: eventData.attendees.split(',').map(em => em.trim()).filter(Boolean), source: 'dashboard_quick_action', created_at: new Date().toISOString() };
                successMessage = 'ğŸ“… Evento criado com sucesso!';
            } else { // bulk
                endpoint = config.ENDPOINTS.CREATE_BULK_TASKS;
                payload = { bulk_text: bulkData.text, default_setor: bulkData.default_setor, default_priority: bulkData.default_priority, default_assignee: bulkData.default_assignee, source: 'dashboard_bulk_action', created_at: new Date().toISOString() };
                successMessage = 'ğŸ¤– Tarefas em massa enviadas para processamento!';
            }

            const response = await fetch(`${config.N8N_BASE_URL}${endpoint}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();

            if (result.success) {
                showNotification(successMessage, 'success');
                onClose();
                setTimeout(refreshData, 2000);
            } else {
                throw new Error(result.message || `Erro ao criar ${activeTab}`);
            }
        } catch (error) {
            showNotification(`âŒ Erro: ${error.message}`, 'error');
        } finally {
            setSubmitting(false);
        }
    };
    
    const renderForm = () => {
        const commonInputStyle = {width: '100%', padding: '14px 18px', border: '1px solid var(--border-color)', borderRadius: '12px', fontSize: '1rem', fontFamily: 'inherit', transition: 'all 0.2s ease', background: '#16161A', color: 'var(--text-primary)'};
        const formGroupStyle = {marginBottom: '20px'};
        const formLabelStyle = {display: 'block', fontWeight: 600, color: 'var(--text-secondary)', marginBottom: '10px', fontSize: '0.9rem'};
        const formRowStyle = {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '16px'};

        switch(activeTab) {
            case 'task':
                return (
                    <>
                        <div style={formGroupStyle}>
                            <label style={formLabelStyle}>ğŸ“ TÃ­tulo da Tarefa</label>
                            <input type="text" value={taskData.title} onChange={e => setTaskData({...taskData, title: e.target.value})} style={commonInputStyle} placeholder="Ex: Finalizar mix da mÃºsica" required />
                        </div>
                        <div style={formRowStyle}>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>ğŸ¢ Setor</label>
                                <select value={taskData.setor} onChange={e => setTaskData({...taskData, setor: e.target.value})} style={commonInputStyle} required>
                                    <option value="">Selecionar setor</option>
                                    <option value="Design">ğŸ¨ Design</option>
                                    <option value="Audiovisual">ğŸ¬ Audiovisual</option>
                                    <option value="Social Media">ğŸ“± Social Media</option>
                                    <option value="GestÃ£o de Projetos">ğŸ“Š GestÃ£o de Projetos</option>
                                    <option value="EstÃºdio">ğŸµ EstÃºdio</option>
                                    <option value="MÃºsico">ğŸ¤ MÃºsico</option>
                                    <option value="Geral">ğŸ“‹ Geral</option>
                                </select>
                            </div>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>âš¡ Prioridade</label>
                                <select value={taskData.priority} onChange={e => setTaskData({...taskData, priority: e.target.value})} style={commonInputStyle}>
                                    <option value="normal">ğŸ“Œ Normal</option>
                                    <option value="high">ğŸ”¥ Alta</option>
                                    <option value="urgent">ğŸš¨ Urgente</option>
                                    <option value="low">ğŸ“‹ Baixa</option>
                                </select>
                            </div>
                        </div>
                        <div style={formGroupStyle}>
                            <label style={{...formLabelStyle, display: 'flex', alignItems: 'center', justifyContent: 'space-between'}}>
                                <span>ğŸ“„ DescriÃ§Ã£o</span>
                                <button type="button" onClick={handleGenerateDescription} disabled={isGenerating} style={{background: 'none', border: '1px solid var(--primary-purple)', color: 'var(--primary-purple)', padding: '4px 8px', borderRadius: '8px', cursor: 'pointer', fontSize: '0.8rem'}}>
                                    {isGenerating ? 'Gerando...' : 'âœ¨ Gerar com IA'}
                                </button>
                            </label>
                            <textarea value={taskData.description} onChange={e => setTaskData({...taskData, description: e.target.value})} style={{...commonInputStyle, resize: 'vertical', minHeight: '120px'}} placeholder="Detalhes da tarefa..."></textarea>
                        </div>
                    </>
                );
            case 'event':
                return (
                     <>
                        <div style={formGroupStyle}>
                            <label style={formLabelStyle}>ğŸ“… TÃ­tulo do Evento</label>
                            <input type="text" value={eventData.title} onChange={e => setEventData({...eventData, title: e.target.value})} style={commonInputStyle} placeholder="Ex: ReuniÃ£o CNP" required />
                        </div>
                        <div style={formRowStyle}>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>ğŸ“… Data</label>
                                <input type="date" value={eventData.date} onChange={e => setEventData({...eventData, date: e.target.value})} style={commonInputStyle} required />
                            </div>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>ğŸ• HorÃ¡rio</label>
                                <input type="time" value={eventData.time} onChange={e => setEventData({...eventData, time: e.target.value})} style={commonInputStyle} required />
                            </div>
                        </div>
                        <div style={formRowStyle}>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>â±ï¸ DuraÃ§Ã£o (minutos)</label>
                                <select value={eventData.duration} onChange={e => setEventData({...eventData, duration: e.target.value})} style={commonInputStyle}>
                                    <option value="30">30 min</option>
                                    <option value="60">1 hora</option>
                                    <option value="90">1:30h</option>
                                    <option value="120">2 horas</option>
                                </select>
                            </div>
                            <div style={formGroupStyle}>
                                <label style={formLabelStyle}>ğŸ“ Local</label>
                                <input type="text" value={eventData.location} onChange={e => setEventData({...eventData, location: e.target.value})} style={commonInputStyle} placeholder="Ex: Google Meet, EstÃºdio" />
                            </div>
                        </div>
                        <div style={formGroupStyle}>
                            <label style={formLabelStyle}>ğŸ‘¥ Participantes (emails)</label>
                            <input type="text" value={eventData.attendees} onChange={e => setEventData({...eventData, attendees: e.target.value})} style={commonInputStyle} placeholder="email1@exemplo.com, email2@exemplo.com" />
                        </div>
                    </>
                );
            case 'bulk':
                 return (
                    <>
                        <div style={formGroupStyle}>
                            <label style={formLabelStyle}>ğŸ“‹ Demandas Desestruturadas</label>
                            <textarea value={bulkData.text} onChange={e => setBulkData({...bulkData, text: e.target.value})} style={{...commonInputStyle, minHeight: '150px', resize: 'vertical'}} placeholder="Cole aqui as suas demandas em qualquer formato..." required></textarea>
                            <small style={{color: 'var(--text-tertiary)', fontSize: '0.8rem', marginTop: '8px', display: 'block'}}>
                                ğŸ’¡ Dica: Cole as suas demandas em qualquer formato. A nossa IA irÃ¡ organizÃ¡-las automaticamente.
                            </small>
                        </div>
                    </>
                );
            default: return null;
        }
    }

    return (
        <div className="quick-modal active" style={{position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', background: 'rgba(13, 12, 34, 0.7)', backdropFilter: 'blur(8px)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', animation: 'fadeIn 0.3s ease'}}>
            <div ref={modalRef} className="modal-content" style={{background: 'var(--card-bg-solid)', border: '1px solid var(--border-color)', borderRadius: '24px', width: '90%', maxWidth: '550px', maxHeight: '90vh', overflowY: 'auto', boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)', animation: 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)', position: 'relative'}}>
                <button onClick={onClose} className="modal-close" style={{position: 'absolute', top: '20px', right: '20px', background: 'rgba(255, 255, 255, 0.1)', border: 'none', width: '36px', height: '36px', borderRadius: '50%', fontSize: '18px', color: 'var(--text-secondary)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', transition: 'all 0.2s ease'}}>âœ•</button>
                <div className="modal-header" style={{padding: '32px 32px 0'}}>
                    <h2 className="modal-title" style={{fontSize: '1.8rem', fontWeight: 700, color: 'var(--text-primary)', marginBottom: '24px', display: 'flex', alignItems: 'center', gap: '12px'}}>âš¡ Quick Actions</h2>
                </div>
                <div className="modal-tabs" style={{display: 'flex', gap: '8px', marginBottom: '24px', borderBottom: '1px solid var(--border-color)', padding: '0 32px'}}>
                    <button className={`tab-btn ${activeTab === 'task' ? 'active' : ''}`} onClick={() => setActiveTab('task')} style={{flex: 1, padding: '14px 16px', border: 'none', borderBottom: `3px solid ${activeTab === 'task' ? 'var(--primary-purple)' : 'transparent'}`, background: 'transparent', color: activeTab === 'task' ? 'var(--primary-purple)' : 'var(--text-secondary)', borderRadius: 0, cursor: 'pointer', fontWeight: 600, transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}>âœ… Nova Tarefa</button>
                    <button className={`tab-btn ${activeTab === 'event' ? 'active' : ''}`} onClick={() => setActiveTab('event')} style={{flex: 1, padding: '14px 16px', border: 'none', borderBottom: `3px solid ${activeTab === 'event' ? 'var(--primary-purple)' : 'transparent'}`, background: 'transparent', color: activeTab === 'event' ? 'var(--primary-purple)' : 'var(--text-secondary)', borderRadius: 0, cursor: 'pointer', fontWeight: 600, transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}>ğŸ“… Novo Evento</button>
                    <button className={`tab-btn ${activeTab === 'bulk' ? 'active' : ''}`} onClick={() => setActiveTab('bulk')} style={{flex: 1, padding: '14px 16px', border: 'none', borderBottom: `3px solid ${activeTab === 'bulk' ? 'var(--primary-purple)' : 'transparent'}`, background: 'transparent', color: activeTab === 'bulk' ? 'var(--primary-purple)' : 'var(--text-secondary)', borderRadius: 0, cursor: 'pointer', fontWeight: 600, transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px'}}>ğŸ“‹ Em Massa</button>
                </div>
                <form onSubmit={handleFormSubmit} style={{padding: '24px 32px 32px'}}>
                    {renderForm()}
                    <div className="form-actions" style={{display: 'flex', gap: '12px', marginTop: '32px', paddingTop: '24px', borderTop: '1px solid var(--border-color)'}}>
                        <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1, padding: '16px 20px', border: 'none', borderRadius: '12px', fontWeight: 700, fontSize: '1rem', cursor: 'pointer', transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', background: 'rgba(255, 255, 255, 0.1)', color: 'var(--text-secondary)'}}>Cancelar</button>
                        <button type="submit" className="btn btn-primary" disabled={isSubmitting} style={{flex: 1, padding: '16px 20px', border: 'none', borderRadius: '12px', fontWeight: 700, fontSize: '1rem', cursor: 'pointer', transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', background: 'var(--primary-purple)', color: 'white', position: 'relative'}}>
                            {isSubmitting && <span className="btn-loading"></span>}
                            <span style={{visibility: isSubmitting ? 'hidden' : 'visible'}}>
                                {activeTab === 'task' ? 'âœ… Criar Tarefa' : activeTab === 'event' ? 'ğŸ“… Criar Evento' : 'ğŸ¤– Enviar para IA'}
                            </span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    );
};


const DecompositionModal = ({ task, onClose, showNotification, config, refreshData }) => {
    const modalRef = useRef(null);
    const [subTasks, setSubTasks] = useState([]);
    const [selectedTasks, setSelectedTasks] = useState([]);
    const [isGenerating, setIsGenerating] = useState(true);
    const [isCreating, setIsCreating] = useState(false);
    const [error, setError] = useState('');

    useEffect(() => {
        const handleClickOutside = (event) => {
            if (modalRef.current && !modalRef.current.contains(event.target)) {
                onClose();
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        
        const generateSubTasks = async () => {
            try {
                const prompt = `Quebre a seguinte tarefa principal em 3 a 5 subtarefas acionÃ¡veis. A tarefa principal Ã©: "${task.title}". A descriÃ§Ã£o Ã©: "${task.description}". O setor Ã© "${task.setor}". Responda com um array JSON de strings, onde cada string Ã© uma subtarefa. Exemplo de formato: ["Subtarefa 1", "Subtarefa 2"]`;
                const payload = {
                    contents: [{ role: "user", parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: { type: "ARRAY", items: { type: "STRING" } }
                    }
                };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    const parsedSubtasks = JSON.parse(text);
                    setSubTasks(parsedSubtasks);
                    setSelectedTasks(parsedSubtasks); // Seleciona todas por padrÃ£o
                } else {
                    throw new Error("A API nÃ£o retornou subtarefas.");
                }
            } catch (err) {
                setError("NÃ£o foi possÃ­vel gerar subtarefas. Tente novamente.");
                showNotification(`Erro ao gerar subtarefas: ${err.message}`, "error");
            } finally {
                setIsGenerating(false);
            }
        };

        generateSubTasks();

        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, [task, showNotification]);

    const handleCheckboxChange = (taskTitle) => {
        setSelectedTasks(prev => 
            prev.includes(taskTitle) ? prev.filter(t => t !== taskTitle) : [...prev, taskTitle]
        );
    };

    const handleCreateTasks = async () => {
        if (selectedTasks.length === 0) {
            showNotification("Nenhuma subtarefa selecionada.", "error");
            return;
        }
        setIsCreating(true);
        const creationPromises = selectedTasks.map(title => {
            const payload = {
                title: title,
                setor: task.setor,
                priority: task.priority,
                description: `Subtarefa de: "${task.title}"`,
                source: 'dashboard_decomposition',
                created_at: new Date().toISOString()
            };
            return fetch(`${config.N8N_BASE_URL}${config.ENDPOINTS.CREATE_TASK}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
        });

        try {
            const results = await Promise.all(creationPromises);
            const successCount = results.filter(res => res.ok).length;
            if (successCount > 0) {
                showNotification(`${successCount} subtarefa(s) criada(s) com sucesso!`, "success");
                refreshData();
                onClose();
            }
            if (successCount < selectedTasks.length) {
                showNotification(`${selectedTasks.length - successCount} falharam ao ser criadas.`, "error");
            }
        } catch (err) {
            showNotification("Erro ao criar subtarefas.", "error");
        } finally {
            setIsCreating(false);
        }
    };

    return (
        <div className="quick-modal active" style={{position: 'fixed', top: 0, left: 0, width: '100%', height: '100%', background: 'rgba(13, 12, 34, 0.7)', backdropFilter: 'blur(8px)', zIndex: 2000, display: 'flex', alignItems: 'center', justifyContent: 'center', animation: 'fadeIn 0.3s ease'}}>
            <div ref={modalRef} className="modal-content" style={{background: 'var(--card-bg-solid)', border: '1px solid var(--border-color)', borderRadius: '24px', width: '90%', maxWidth: '550px', maxHeight: '90vh', overflowY: 'auto', boxShadow: '0 20px 60px rgba(0, 0, 0, 0.5)', animation: 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)', position: 'relative'}}>
                <button onClick={onClose} className="modal-close" style={{position: 'absolute', top: '20px', right: '20px', background: 'rgba(255, 255, 255, 0.1)', border: 'none', width: '36px', height: '36px', borderRadius: '50%', fontSize: '18px', color: 'var(--text-secondary)', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', transition: 'all 0.2s ease'}}>âœ•</button>
                <div className="modal-header" style={{padding: '32px 32px 24px'}}>
                    <h2 className="modal-title" style={{fontSize: '1.5rem', fontWeight: 700, color: 'var(--text-primary)', display: 'flex', alignItems: 'center', gap: '12px'}}>âœ¨ Decompor Tarefa</h2>
                    <p style={{color: 'var(--text-secondary)'}}>Tarefa principal: <strong style={{color: 'var(--primary-purple-light)'}}>{task.title}</strong></p>
                </div>
                <div style={{padding: '0 32px 32px'}}>
                    {isGenerating ? <LoadingIndicator show={true} /> : error ? <p style={{color: '#F87171'}}>{error}</p> : (
                        <div>
                            <p style={{color: 'var(--text-secondary)', marginBottom: '16px'}}>A IA sugeriu as seguintes subtarefas. Selecione quais deseja criar:</p>
                            <div style={{display: 'flex', flexDirection: 'column', gap: '12px'}}>
                                {subTasks.map((sub, index) => (
                                    <label key={index} style={{display: 'flex', alignItems: 'center', gap: '12px', background: 'rgba(255, 255, 255, 0.05)', padding: '12px', borderRadius: '8px'}}>
                                        <input type="checkbox" checked={selectedTasks.includes(sub)} onChange={() => handleCheckboxChange(sub)} style={{width: '18px', height: '18px'}} />
                                        <span>{sub}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}
                    <div className="form-actions" style={{display: 'flex', gap: '12px', marginTop: '32px', paddingTop: '24px', borderTop: '1px solid var(--border-color)'}}>
                        <button type="button" className="btn btn-secondary" onClick={onClose} style={{flex: 1, padding: '16px 20px', border: 'none', borderRadius: '12px', fontWeight: 700, fontSize: '1rem', cursor: 'pointer', transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', background: 'rgba(255, 255, 255, 0.1)', color: 'var(--text-secondary)'}}>Cancelar</button>
                        <button type="button" onClick={handleCreateTasks} className="btn btn-primary" disabled={isCreating || isGenerating || selectedTasks.length === 0} style={{flex: 1, padding: '16px 20px', border: 'none', borderRadius: '12px', fontWeight: 700, fontSize: '1rem', cursor: 'pointer', transition: 'all 0.2s ease', display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', background: 'var(--primary-purple)', color: 'white', position: 'relative'}}>
                            {isCreating && <span className="btn-loading"></span>}
                            <span style={{visibility: isCreating ? 'hidden' : 'visible'}}>
                                âœ… Criar Selecionadas ({selectedTasks.length})
                            </span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
};


const LoadingIndicator = ({ show }) => {
    if (!show) return null;
    return (
        <div className="loading" style={{display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', textAlign: 'center', padding: '40px', color: 'white', position: 'fixed', top: '50%', left: '50%', transform: 'translate(-50%, -50%)', background: 'rgba(22, 22, 26, 0.9)', border: '1px solid var(--border-color)', borderRadius: 'var(--border-radius)', backdropFilter: 'blur(var(--backdrop-blur))', zIndex: 10000}}>
            <div className="spinner" style={{width: '40px', height: '40px', border: '4px solid rgba(127, 90, 240, 0.3)', borderTop: '4px solid var(--primary-purple)', borderRadius: '50%', animation: 'spin 1s linear infinite', margin: '0 auto 20px'}}></div>
            <p>A sincronizar...</p>
        </div>
    );
};

const NotificationCenter = ({ notifications }) => (
    <div style={{position: 'fixed', top: '20px', right: '20px', zIndex: 10001, display: 'flex', flexDirection: 'column', gap: '10px'}}>
        {notifications.map(n => (
            <div key={n.id} className={`notification ${n.type}`} style={{padding: '14px 22px', borderRadius: '12px', color: 'white', fontWeight: 600, border: '1px solid rgba(255, 255, 255, 0.1)', backdropFilter: 'blur(5px)', animation: 'slideIn 0.3s ease, slideOut 0.3s ease 3s forwards', background: n.type === 'success' ? 'rgba(44, 182, 125, 0.8)' : n.type === 'error' ? 'rgba(239, 68, 68, 0.8)' : 'rgba(127, 90, 240, 0.8)'}}>
                {n.message}
            </div>
        ))}
    </div>
);
